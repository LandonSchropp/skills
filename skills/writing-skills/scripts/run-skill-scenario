#!/usr/bin/env ruby
# frozen_string_literal: true

require 'fileutils'
require 'json'
require 'optparse'
require_relative 'commands'

def log(scenario_number, run_number, message)
  $stderr.puts "\033[34m[run-skill-scenario] - Scenario #{scenario_number} - Run #{run_number} - #{message}\033[0m"
end

options = {
  no_plugin: false
}

parser = OptionParser.new do |opts|
  opts.summary_indent = ""
  opts.banner = "Usage: run-skill-scenario --task <task> --scenario-number <number> --run-number <number> [OPTIONS]"
  opts.separator ""
  opts.separator "Runs a single task with Claude and outputs the skills invoked and conversation log."
  opts.separator ""
  opts.separator "Required Arguments:"
  opts.separator ""

  opts.on("--task <task>", "The task to execute") do
    options[:task] = _1
  end

  opts.on("--scenario-number <number>", Integer, "The scenario number") do
    options[:scenario_number] = _1
  end

  opts.on("--run-number <number>", Integer, "The run number") do
    options[:run_number] = _1
  end

  opts.separator ""
  opts.separator "Options:"
  opts.separator ""

  opts.on("--no-plugin", "Disables the plugin directory (no skills available)") do
    options[:no_plugin] = true
  end

  opts.on("--help", "Displays the usage information.") do
    puts opts
    exit 0
  end

  opts.separator ""
  opts.separator "Examples:"
  opts.separator ""
  opts.separator '    run-skill-scenario --task "Write a function that adds two numbers"'
  opts.separator '    run-skill-scenario --task "What does the factorial function do?" --no-plugin'
end

parser.parse!

if options[:task].nil?
  puts "Error: --task is required"
  puts ""
  puts parser
  exit 1
end

if options[:scenario_number].nil?
  puts "Error: --scenario-number is required"
  puts ""
  puts parser
  exit 1
end

if options[:run_number].nil?
  puts "Error: --run-number is required"
  puts ""
  puts parser
  exit 1
end

task = options[:task]
scenario_number = options[:scenario_number]
run_number = options[:run_number]

log(scenario_number, run_number, "Starting")

script_directory = File.dirname(__FILE__)
project_root = File.expand_path('../..', script_directory)

directory_name = "skill-test-run-#{scenario_number}-#{run_number}"
test_directory = File.join(project_root, 'tmp', directory_name)
FileUtils.rm_rf(test_directory) if File.exist?(test_directory)
FileUtils.mkdir_p(test_directory)

log_file = File.join(test_directory, 'conversation.json')
claude_log_file = File.join(test_directory, 'run-skill-scenario-claude.log')

Dir.chdir(test_directory) do
  prompt = <<~PROMPT
    You are an expert software development AI tasked with completing the following task.

    IMPORTANT: Only create and edit files in the provided working directory. Do not read or write
    files outside of this directory.

    Task: #{task}
    Working directory: #{test_directory}
  PROMPT

  log(scenario_number, run_number, "Executing Claude Code: #{claude_log_file}")

  begin
    stdout = run_claude_code(prompt: prompt, include_plugin: !options[:no_plugin])
  rescue => e
    log(scenario_number, run_number, "Error: #{e.message}")
    exit 1
  end

  File.write(log_file, stdout)
  File.write(claude_log_file, stdout)
end

begin
  skills = File.read(log_file)
    .split("\n")
    .map { JSON.parse(_1) }
    .flat_map do |data|
    if data['type'] == 'assistant' && data['message']
      content = data.dig('message', 'content')
      next unless content.is_a?(Array)

      content.filter_map do |item|
        if item['type'] == 'tool_use' && item['name'] == 'Skill'
          item.dig('input', 'skill')
        end
      end
    end
  end
  .compact
  .uniq
rescue JSON::ParserError => e
  log(scenario_number, run_number, "Error: Failed to parse conversation log")
  $stderr.puts e.message
  exit 1
end

output = {
  task: task,
  plugin_enabled: !options[:no_plugin],
  skills: skills,
  conversation_log: log_file
}

log(scenario_number, run_number, "Complete")
puts JSON.pretty_generate(output)
