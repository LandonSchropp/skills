#!/usr/bin/env ruby
# frozen_string_literal: true

require 'fileutils'
require 'json'
require 'open3'
require 'optparse'

options = {
  no_plugin: false,
  task: nil,
  number: nil
}

parser = OptionParser.new do |opts|
  opts.summary_indent = ""
  opts.banner = "Usage: run-skill-scenario --task <task> [OPTIONS]"
  opts.separator ""
  opts.separator "Runs a single task with Claude and outputs the skills invoked and conversation log."
  opts.separator ""
  opts.separator "Required Arguments:"
  opts.separator ""

  opts.on("--task <task>", "The task to execute") do
    options[:task] = _1
  end

  opts.separator ""
  opts.separator "Options:"
  opts.separator ""

  opts.on("--number <n>", Integer, "Run number (for parallel execution)") do
    options[:number] = _1
  end

  opts.on("--no-plugin", "Disables the plugin directory (no skills available)") do
    options[:no_plugin] = true
  end

  opts.on("--help", "Displays the usage information.") do
    puts opts
    exit 0
  end

  opts.separator ""
  opts.separator "Examples:"
  opts.separator ""
  opts.separator '    run-skill-scenario --task "Write a function that adds two numbers"'
  opts.separator '    run-skill-scenario --task "What does the factorial function do?" --no-plugin'
end

parser.parse!

if options[:task].nil?
  puts "Error: --task is required"
  puts ""
  puts parser
  exit 1
end

task = options[:task]
number = options[:number]

script_dir = File.dirname(__FILE__)
project_root = File.expand_path('../..', script_dir)

dir_name = number ? "skill-test-run-#{number}" : 'skill-test-run'
test_directory = File.join(project_root, 'tmp', dir_name)
FileUtils.rm_rf(test_directory) if File.exist?(test_directory)
FileUtils.mkdir_p(test_directory)

log_file = File.join(test_directory, 'conversation.json')

Dir.chdir(test_directory) do
  command = [
    'claude',
    '--print',
    '--verbose',
    '--output-format', 'stream-json',
    '--dangerously-skip-permissions'
  ]

  command.concat(['--plugin-dir', project_root]) unless options[:no_plugin]

  prompt_instructions = <<~INSTRUCTIONS
    You are an expert software development AI tasked with completing the following task.

    IMPORTANT: Only create and edit files in the provided working directory. Do not read or write
    files outside of this directory.

    Task: #{task}
    Working directory: #{test_directory}
  INSTRUCTIONS

  unless options[:no_plugin]
    prompt_instructions += <<~INSTRUCTIONS

      **CRITICAL: Upon starting ANY conversation or receiving ANY task, you MUST immediately invoke
      the `using-skills` skill as your first action before any other response.**
    INSTRUCTIONS
  end

  stdout, stderr, status = Open3.capture3(*command, stdin_data: prompt_instructions)

  File.write(log_file, stdout)
  File.write(File.join(test_directory, 'stderr.log'), stderr) if stderr && !stderr.empty?
end

skills = File.read(log_file)
  .split("\n")
  .map { JSON.parse(_1) }
  .flat_map do |data|
    if data['type'] == 'assistant' && data['message']
      content = data.dig('message', 'content')
      next unless content.is_a?(Array)

      content.filter_map do |item|
        if item['type'] == 'tool_use' && item['name'] == 'Skill'
          item.dig('input', 'skill')
        end
      end
    end
  end
  .compact
  .uniq

output = {
  task: task,
  plugin_enabled: !options[:no_plugin],
  skills: skills,
  conversation_log: log_file
}

puts JSON.pretty_generate(output)
